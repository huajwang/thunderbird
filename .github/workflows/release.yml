# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Thunderbird SDK â€” Release Pipeline (v3)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
# Triggered on semantic-version tags:
#   vX.Y.Z        â†’ Production release (environment: production)
#   vX.Y.Z-rc.N   â†’ Staging release candidate (environment: staging)
#
# Artifact promotion model:
#
#   Dev  (:dev-<sha7>)           â† CI push to main  (ci.yml)
#   Staging (:X.Y.Z-rc.N)       â† RC tag push       (this workflow)
#   Production (:X.Y.Z :X.Y :X) â† vX.Y.Z tag        (this workflow)
#                                  OR promote.yml    (zero-rebuild)
#
# Immutability: production tags are write-once.  If promote.yml already
# created the release, this pipeline detects it and skips gracefully.
#
# Single tag push produces: .deb Ã— 2 arch, .whl Ã— 2 arch Ã— 4 Python,
# Docker Ã— 2 variant Ã— 2 arch, GitHub Release with checksums + cosign.
#
# Pipeline topology:
#
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚     preflight      â”‚ extract version, validate tag, dedup guard,
#   â”‚                    â”‚ generate changelog from Git commits
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#             â”‚
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚            parallel build + test matrix                 â”‚
#   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
#   â”‚  â”‚ build-debâ”‚  â”‚build-whl â”‚  â”‚   test   â”‚             â”‚
#   â”‚  â”‚ x86 arm64â”‚  â”‚ x86 arm64â”‚  â”‚ x86 arm64â”‚             â”‚
#   â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#           â”‚              â”‚             â”‚
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚                    docker                               â”‚
#   â”‚   runtime + dev images (linux/amd64 + linux/arm64)      â”‚
#   â”‚   pushed to GHCR, signed with cosign                    â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                           â”‚
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚                    release                              â”‚
#   â”‚   Create GitHub Release with auto-changelog             â”‚
#   â”‚   Attach .deb + .whl + SHA256SUMS                       â”‚
#   â”‚   Sign checksum blob with cosign (Sigstore OIDC)        â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
name: Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"           # vX.Y.Z (production)
      - "v[0-9]+.[0-9]+.[0-9]+-rc.[0-9]+" # vX.Y.Z-rc.N (staging)

permissions:
  contents: read               # default read; jobs escalate individually

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false            # NEVER cancel a release in flight

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  Stage 1 â€” Preflight (validation + changelog generation)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
jobs:
  preflight:
    name: "Preflight"
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      version:       ${{ steps.meta.outputs.version }}        # base X.Y.Z
      full_version:  ${{ steps.meta.outputs.full_version }}   # X.Y.Z or X.Y.Z-rc.N
      is_rc:         ${{ steps.meta.outputs.is_rc }}          # 'true' or 'false'
      channel:       ${{ steps.meta.outputs.channel }}        # staging or production
      skip:          ${{ steps.dedup.outputs.skip }}          # 'true' if already released
      version_major: ${{ steps.meta.outputs.major }}
      version_minor: ${{ steps.meta.outputs.minor }}
      version_patch: ${{ steps.meta.outputs.patch }}
      changelog:     ${{ steps.changelog.outputs.path }}
    steps:
      # â”€â”€ Parse and validate tag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Extract version from tag
        id: meta
        run: |
          TAG="${GITHUB_REF_NAME}"                     # e.g. v1.2.3 or v1.2.3-rc.1
          FULL_VER="${TAG#v}"                           # 1.2.3 or 1.2.3-rc.1

          # Validate: vX.Y.Z or vX.Y.Z-rc.N
          if [[ "${FULL_VER}" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)(-rc\.([0-9]+))?$ ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
            BASE_VER="${MAJOR}.${MINOR}.${PATCH}"
          else
            echo "::error::Tag '${TAG}' is not valid (expected vX.Y.Z or vX.Y.Z-rc.N)"
            exit 1
          fi

          if [[ -n "${BASH_REMATCH[5]}" ]]; then
            IS_RC="true"
            CHANNEL="staging"
          else
            IS_RC="false"
            CHANNEL="production"
          fi

          echo "version=${BASE_VER}"         >> "$GITHUB_OUTPUT"
          echo "full_version=${FULL_VER}"    >> "$GITHUB_OUTPUT"
          echo "is_rc=${IS_RC}"              >> "$GITHUB_OUTPUT"
          echo "channel=${CHANNEL}"          >> "$GITHUB_OUTPUT"
          echo "major=${MAJOR}"              >> "$GITHUB_OUTPUT"
          echo "minor=${MINOR}"              >> "$GITHUB_OUTPUT"
          echo "patch=${PATCH}"              >> "$GITHUB_OUTPUT"

          echo "### ðŸ·ï¸ Release: \`${FULL_VER}\` (${CHANNEL})" >> "$GITHUB_STEP_SUMMARY"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0             # full history for changelog generation

      # â”€â”€ Verify CMakeLists.txt version matches tag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify CMake version matches tag
        run: |
          chmod +x scripts/extract-version.sh
          CMAKE_VER=$(scripts/extract-version.sh --from-cmake)
          TAG_VER="${{ steps.meta.outputs.version }}"
          if [ "${CMAKE_VER}" != "${TAG_VER}" ]; then
            echo "::error::CMake version (${CMAKE_VER}) â‰  tag (${TAG_VER}). Update CMakeLists.txt before tagging."
            exit 1
          fi
          echo "âœ“ CMake version matches tag: ${TAG_VER}"

      # â”€â”€ Check for existing release (may have been promoted) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Check for existing release
        id: dedup
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view "${{ github.ref_name }}" &>/dev/null; then
            echo "::notice::Release ${{ github.ref_name }} already exists (may have been promoted). Skipping pipeline."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "âœ“ No existing release â€” proceeding with build"
          fi

      # â”€â”€ Generate changelog from Git commits â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate changelog from commits
        id: changelog
        if: steps.dedup.outputs.skip != 'true'
        run: |
          chmod +x scripts/generate-release-notes.sh
          scripts/generate-release-notes.sh \
            "${{ steps.meta.outputs.full_version }}" \
            > /tmp/release_notes_base.md
          echo "path=/tmp/release_notes_base.md" >> "$GITHUB_OUTPUT"

          echo "### ðŸ“‹ Changelog preview" >> "$GITHUB_STEP_SUMMARY"
          head -50 /tmp/release_notes_base.md >> "$GITHUB_STEP_SUMMARY"

      # â”€â”€ Upload changelog as artifact (for release job) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload changelog artifact
        if: steps.dedup.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: /tmp/release_notes_base.md
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  Stage 2a â€” Build Debian packages (x86_64 + arm64)
  #             dpkg-buildpackage inside Ubuntu 22.04 (Debian policy compliant)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-deb:
    name: "Deb ${{ matrix.arch }}"
    if: needs.preflight.outputs.skip != 'true'
    needs: [preflight]
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
    container:
      image: ubuntu:22.04
    strategy:
      fail-fast: true
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm
    env:
      DEBIAN_FRONTEND: noninteractive
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          apt-get update -qq
          apt-get install -y --no-install-recommends \
            build-essential cmake pkg-config g++ \
            dpkg-dev debhelper devscripts fakeroot lintian \
            ca-certificates git

      - name: Stamp debian/changelog
        run: |
          chmod +x scripts/update-changelog.sh scripts/extract-version.sh
          scripts/update-changelog.sh \
            "${{ needs.preflight.outputs.version }}" \
            "jammy"

      - name: Build .deb packages
        run: |
          dpkg-buildpackage -us -uc -b --jobs="$(nproc)" -d
        env:
          DEB_BUILD_OPTIONS: "nocheck"
          THUNDERBIRD_VERSION_OVERRIDE: ${{ needs.preflight.outputs.version }}

      - name: Run tests
        run: |
          cd obj-* 2>/dev/null || cd debian/.debhelper/generated/*/build 2>/dev/null || true
          if [ -f CTestTestfile.cmake ]; then
            ctest --output-on-failure -j "$(nproc)"
          fi

      - name: Collect and verify .deb artifacts
        run: |
          mkdir -p dist
          cp ../*.deb dist/ 2>/dev/null || cp *.deb dist/ 2>/dev/null || true
          echo "=== Built packages ==="
          ls -lh dist/
          echo ""
          lintian --no-tag-display-limit dist/*.deb || true
          echo ""
          echo "=== libthunderbird-sdk0 ==="
          dpkg-deb -c dist/libthunderbird-sdk0_*.deb | head -20
          echo ""
          echo "=== libthunderbird-sdk-dev ==="
          dpkg-deb -c dist/libthunderbird-sdk-dev_*.deb | head -20

      - name: Upload .deb artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.arch }}
          path: dist/*.deb
          retention-days: 5

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  Stage 2b â€” Build Python wheels (manylinux2014, x86_64 + aarch64)
  #             CPython 3.9â€“3.12, auditwheel-repaired, static-libstdc++
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-wheel:
    name: "Wheel ${{ matrix.arch }}"
    if: needs.preflight.outputs.skip != 'true'
    needs: [preflight]
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
    strategy:
      fail-fast: true
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-24.04
            cibw_arch: x86_64
          - arch: aarch64
            runner: ubuntu-24.04-arm
            cibw_arch: aarch64
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip                   # caches ~/.cache/pip keyed on pyproject.toml

      - name: Install cibuildwheel
        run: pip install cibuildwheel==2.21.*

      - name: Build wheels
        run: cibuildwheel --output-dir dist
        env:
          CIBW_BUILD: >-
            cp39-manylinux_*
            cp310-manylinux_*
            cp311-manylinux_*
            cp312-manylinux_*
          CIBW_SKIP: >-
            *-musllinux_* pp* *_i686 *_s390x *_ppc64le
          CIBW_ARCHS_LINUX: ${{ matrix.cibw_arch }}
          CIBW_MANYLINUX_X86_64_IMAGE:  manylinux2014
          CIBW_MANYLINUX_AARCH64_IMAGE: manylinux2014
          CIBW_BEFORE_ALL_LINUX: >-
            yum install -y ninja-build || true &&
            /opt/python/cp312-cp312/bin/pip install cmake &&
            ln -sf /opt/python/cp312-cp312/bin/cmake /usr/local/bin/cmake &&
            cmake --version
          CIBW_CONFIG_SETTINGS: >-
            cmake.define.THUNDERBIRD_VERSION_OVERRIDE=${{ needs.preflight.outputs.version }}
          CIBW_ENVIRONMENT: >-
            THUNDERBIRD_VERSION_OVERRIDE=${{ needs.preflight.outputs.version }}
          CIBW_REPAIR_WHEEL_COMMAND_LINUX: >-
            auditwheel show {wheel};
            auditwheel repair
            --plat manylinux2014_$(uname -m)
            -w {dest_dir} {wheel}
          CIBW_TEST_COMMAND: >-
            python -c
            "import spatial_sdk; v = spatial_sdk.__version__; print(f'spatial_sdk {v}'); assert v == '${{ needs.preflight.outputs.version }}', f'Version mismatch: {v} != ${{ needs.preflight.outputs.version }}'; print(f'Status.OK = {spatial_sdk.Status.OK}'); print('OK')"

      - name: Verify wheel metadata
        run: |
          pip install pkginfo
          for whl in dist/*.whl; do
            echo "=== $(basename $whl) ==="
            python -c "
          from pkginfo import Wheel
          w = Wheel('$whl')
          print(f'  Name:     {w.name}')
          print(f'  Version:  {w.version}')
          print(f'  Requires: {w.requires_python}')
          assert w.version == '${{ needs.preflight.outputs.version }}', \
            f'Wheel version {w.version} != tag ${{ needs.preflight.outputs.version }}'
          print('  âœ“ PEP metadata OK')
          "
          done

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.arch }}
          path: dist/*.whl
          retention-days: 5

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  Stage 2c â€” Test matrix (validates correctness before release)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: "Test ${{ matrix.arch }}"
    if: needs.preflight.outputs.skip != 'true'
    needs: [preflight]
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
    strategy:
      fail-fast: true
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_MAXSIZE: 200M
      CCACHE_COMPRESS: "true"
      CCACHE_COMPRESSLEVEL: "6"
    steps:
      - uses: actions/checkout@v4

      # â”€â”€ apt cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: ~/apt-cache
          key: apt-${{ matrix.runner }}-build-v1

      - name: Install dependencies
        run: |
          if [ -d ~/apt-cache ]; then
            sudo cp -rn ~/apt-cache/. /var/cache/apt/archives/ 2>/dev/null || true
          fi
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake ccache
          mkdir -p ~/apt-cache
          cp -rn /var/cache/apt/archives/*.deb ~/apt-cache/ 2>/dev/null || true

      # â”€â”€ ccache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-release-${{ matrix.arch }}-${{ hashFiles('CMakeLists.txt', 'sdk/**', 'tests/**', 'examples/**') }}
          restore-keys: |
            ccache-release-${{ matrix.arch }}-

      - name: Configure ccache
        run: |
          ccache --zero-stats
          ccache --max-size="${CCACHE_MAXSIZE}"

      - name: Configure, build, test
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DTHUNDERBIRD_VERSION_OVERRIDE=${{ needs.preflight.outputs.version }} \
            -DTHUNDERBIRD_BUILD_TESTS=ON \
            -DTHUNDERBIRD_BUILD_EXAMPLES=ON \
            -DTHUNDERBIRD_USE_SIMULATED=ON
          cmake --build build -j "$(nproc)"
          cd build && ctest --output-on-failure -j "$(nproc)"

      - name: ccache statistics
        if: always()
        run: ccache --show-stats
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  Stage 3 â€” Docker images (multi-arch via buildx + QEMU)
  #
  #  Tag strategy:  :X.Y.Z  :X.Y  :X  :latest
  #  Platforms:     linux/amd64  linux/arm64
  #  Signed:        cosign keyless (Sigstore OIDC)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  docker:
    name: "Docker ${{ matrix.variant }}"
    needs: [preflight, build-deb, test]
    if: "!cancelled() && !failure() && needs.preflight.outputs.skip != 'true'"
    runs-on: ubuntu-24.04
    environment: ${{ needs.preflight.outputs.channel }}
    permissions:
      contents: read
      packages: write            # push to GHCR
      id-token: write            # cosign keyless signing
    strategy:
      fail-fast: true
      matrix:
        variant: [runtime, dev]
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:v0.14.1
            network=host

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.variant }}
          tags: |
            type=raw,value=${{ needs.preflight.outputs.full_version }}
            type=raw,value=${{ needs.preflight.outputs.version_major }}.${{ needs.preflight.outputs.version_minor }},enable=${{ needs.preflight.outputs.is_rc != 'true' }}
            type=raw,value=${{ needs.preflight.outputs.version_major }},enable=${{ needs.preflight.outputs.is_rc != 'true' }}
            type=raw,value=latest,enable=${{ needs.preflight.outputs.is_rc != 'true' }}
          labels: |
            org.opencontainers.image.title=Thunderbird SDK (${{ matrix.variant }})
            org.opencontainers.image.version=${{ needs.preflight.outputs.full_version }}
            org.opencontainers.image.licenses=MIT

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.${{ matrix.variant }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: VERSION=${{ needs.preflight.outputs.version }}
          cache-from: type=gha,scope=docker-${{ matrix.variant }}
          cache-to: type=gha,mode=max,scope=docker-${{ matrix.variant }},ignore-error=true
          provenance: true
          sbom: true

      - name: Verify multi-arch manifest
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.variant }}:${{ needs.preflight.outputs.full_version }}"
          echo "=== Manifest: ${IMAGE} ==="

          # Retry up to 5 times â€” GHCR can be slow to expose a manifest
          # right after a push, and transient network timeouts happen.
          for attempt in 1 2 3 4 5; do
            echo "Attempt ${attempt}/5 ..."
            if docker buildx imagetools inspect "${IMAGE}" > /tmp/manifest.txt 2>&1; then
              cat /tmp/manifest.txt
              break
            fi
            echo "::warning::Manifest inspect failed (attempt ${attempt}), retrying in 15s..."
            cat /tmp/manifest.txt
            sleep 15
          done

          # Final check â€” fail if the last attempt also failed
          docker buildx imagetools inspect "${IMAGE}" > /dev/null 2>&1 \
            || { echo "::error::Failed to inspect manifest after 5 attempts"; exit 1; }

          ARCHS=$(docker buildx imagetools inspect "${IMAGE}" \
            --format '{{range .Manifest.Manifests}}{{.Platform.Architecture}} {{end}}')
          echo "Architectures: ${ARCHS}"
          echo "${ARCHS}" | grep -q "amd64" || { echo "::error::Missing amd64"; exit 1; }
          echo "${ARCHS}" | grep -q "arm64" || { echo "::error::Missing arm64"; exit 1; }
          echo "âœ“ Multi-arch manifest verified"

      - name: Sign image with cosign
        uses: sigstore/cosign-installer@v3
      - name: Cosign sign + verify
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.variant }}"
          DIGEST="${{ steps.build.outputs.digest }}"

          # Sign
          cosign sign --yes "${IMAGE}@${DIGEST}"

          # Verify (self-check)
          cosign verify \
            --certificate-identity-regexp "github.com/${{ github.repository }}" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            "${IMAGE}@${DIGEST}" | head -5
          echo "âœ“ Cosign signature verified"

      # â”€â”€ Container SBOM (Syft â†’ cosign attest) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate container SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.variant }}@${{ steps.build.outputs.digest }}
          output-file: container-sbom-${{ matrix.variant }}.spdx.json
          format: spdx-json

      - name: Attest container SBOM
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.variant }}"
          DIGEST="${{ steps.build.outputs.digest }}"
          cosign attest --yes \
            --predicate container-sbom-${{ matrix.variant }}.spdx.json \
            --type spdxjson \
            "${IMAGE}@${DIGEST}"
          echo "âœ“ Container SBOM attested"

      # â”€â”€ Trivy scan (fail on CRITICAL) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Trivy container scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.variant }}@${{ steps.build.outputs.digest }}
          format: table
          severity: CRITICAL
          exit-code: 1
          ignore-unfixed: true

      - name: Step summary
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.variant }}"
          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          ### Docker: ${{ matrix.variant }}
          | Property | Value |
          |----------|-------|
          | Image | \`${IMAGE}\` |
          | Version | \`${{ needs.preflight.outputs.full_version }}\` |
          | Digest | \`${{ steps.build.outputs.digest }}\` |
          | Platforms | linux/amd64, linux/arm64 |
          | Signed | âœ“ cosign (Sigstore OIDC) |
          EOF

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  Stage 4 â€” GitHub Release
  #
  #  Collects all artifacts, generates checksums, signs with cosign,
  #  creates GitHub Release with auto-generated changelog, attaches files.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release:
    name: "GitHub Release"
    needs: [preflight, build-deb, build-wheel, test, docker]
    if: "!cancelled() && !failure() && needs.preflight.outputs.skip != 'true'"
    runs-on: ubuntu-24.04
    environment: ${{ needs.preflight.outputs.channel }}
    permissions:
      contents: write            # create GH Release & upload assets
      id-token: write            # cosign blob signing
      attestations: write        # SLSA provenance attestations
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0             # needed for changelog commit range

      # â”€â”€ Collect all build artifacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Download each artifact set individually to avoid transient
      # failures from pulling everything in one shot (GH infra can
      # drop large parallel blob fetches).
      - name: Download deb artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: deb-*
          path: artifacts/
          merge-multiple: true

      - name: Download wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheel-*
          path: artifacts/
          merge-multiple: true

      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: artifacts/notes/

      - name: List collected artifacts
        run: |
          echo "=== All artifacts ==="
          ls -lhR artifacts/
          echo ""
          echo "Debs:   $(ls artifacts/*.deb 2>/dev/null | wc -l)"
          echo "Wheels: $(ls artifacts/*.whl 2>/dev/null | wc -l)"

      # â”€â”€ Generate checksums â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate SHA256 checksums
        run: |
          cd artifacts
          sha256sum *.deb *.whl > SHA256SUMS.txt
          echo "=== Checksums ==="
          cat SHA256SUMS.txt

      # â”€â”€ Sign checksums with cosign â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign checksums blob
        run: |
          cosign sign-blob --yes \
            --output-signature artifacts/SHA256SUMS.txt.sig \
            --output-certificate artifacts/SHA256SUMS.txt.cert \
            artifacts/SHA256SUMS.txt
          echo "âœ“ Checksums signed with cosign"

      # â”€â”€ SBOM for release artifacts (Syft) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate release SBOM
        uses: anchore/sbom-action@v0
        with:
          path: .
          output-file: artifacts/thunderbird-sdk.spdx.json
          format: spdx-json

      # â”€â”€ SLSA provenance attestation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Uses GitHub's native artifact attestation (SLSA Build L2+).
      # Creates Sigstore-backed provenance for each artifact.
      - name: Attest build provenance (debs)
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: artifacts/*.deb

      - name: Attest build provenance (wheels)
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: artifacts/*.whl

      - name: Attest build provenance (checksums)
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: artifacts/SHA256SUMS.txt

      - name: Attest SBOM
        uses: actions/attest-sbom@v2
        with:
          subject-path: artifacts/*.deb
          sbom-path: artifacts/thunderbird-sdk.spdx.json

      # â”€â”€ Generate final release notes (with artifacts table) â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate release notes with artifacts table
        run: |
          chmod +x scripts/generate-release-notes.sh
          scripts/generate-release-notes.sh \
            "${{ needs.preflight.outputs.full_version }}" \
            "artifacts" \
            > /tmp/release_notes.md
          echo ""
          echo "=== Release notes preview (first 60 lines) ==="
          head -60 /tmp/release_notes.md

      # â”€â”€ Create GitHub Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RC_FLAG=""
          if [ "${{ needs.preflight.outputs.is_rc }}" = "true" ]; then
            RC_FLAG="--prerelease"
          fi

          gh release create "${{ github.ref_name }}" \
            --title "Thunderbird SDK ${{ needs.preflight.outputs.full_version }}" \
            --notes-file /tmp/release_notes.md \
            --verify-tag \
            ${RC_FLAG} \
            artifacts/*.deb \
            artifacts/*.whl \
            artifacts/SHA256SUMS.txt \
            artifacts/SHA256SUMS.txt.sig \
            artifacts/SHA256SUMS.txt.cert \
            artifacts/thunderbird-sdk.spdx.json

      # â”€â”€ Post-release verification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify release was created
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Release details ==="
          gh release view "${{ github.ref_name }}"
          echo ""
          ASSET_COUNT=$(gh release view "${{ github.ref_name }}" --json assets -q '.assets | length')
          echo "Assets attached: ${ASSET_COUNT}"

          # Expect: 4 debs + 8 wheels + 3 checksums = 15 minimum
          if [ "${ASSET_COUNT}" -lt 10 ]; then
            echo "::warning::Only ${ASSET_COUNT} assets attached (expected â‰¥10)"
          fi
          echo "âœ“ Release ${{ github.ref_name }} created successfully"

      - name: Step summary
        run: |
          VER="${{ needs.preflight.outputs.full_version }}"
          CHANNEL="${{ needs.preflight.outputs.channel }}"
          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          ### ðŸŽ‰ Release ${VER} Published (${CHANNEL})

          | Artifact type | Count |
          |---------------|-------|
          | Debian packages | $(ls artifacts/*.deb 2>/dev/null | wc -l) |
          | Python wheels | $(ls artifacts/*.whl 2>/dev/null | wc -l) |
          | Checksum files | 3 (SHA256SUMS.txt + .sig + .cert) |
          | Docker images | 2 (runtime + dev) Ã— 2 arch |

          **Release URL**: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}
          EOF
