# ─────────────────────────────────────────────────────────────────────────────
# Thunderbird SDK — Continuous Integration (every push + PR)
# ─────────────────────────────────────────────────────────────────────────────
#
# Runs on every push/PR to main/develop.  NOT triggered by tags (release.yml
# handles those).
#
# Performance targets:
#   • Full CI pass < 10 minutes (cached)
#   • Incremental rebuild < 3 minutes
#
# Caching strategy:
#   • ccache:      compiler output (80%+ hit rate on incremental)
#   • pip:         Python package downloads
#   • apt:         .deb package cache (avoids re-download)
#   • Docker:      BuildKit GHA layer cache (scoped per variant)
#
# Job dependency graph (all independent → max parallelism):
#
#   push/PR
#     ├── build-and-test (3× matrix)
#     ├── deb-smoke
#     ├── wheel-smoke
#     └── docker-smoke  (2× matrix)
#
# ─────────────────────────────────────────────────────────────────────────────
name: CI

on:
  push:
    branches: [main, develop]
    tags-ignore:
      - "v*"
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

# ── Minimal default permissions ──────────────────────────────────────────────
permissions:
  contents: read

jobs:
  build-and-test:
    name: "${{ matrix.os }} / ${{ matrix.build_type }}"
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux-x64
            runner: ubuntu-24.04
            build_type: Release
          - os: linux-x64-debug
            runner: ubuntu-24.04
            build_type: Debug
          - os: linux-arm64
            runner: ubuntu-24.04-arm
            build_type: Release
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_MAXSIZE: 200M
      CCACHE_COMPRESS: "true"
      CCACHE_COMPRESSLEVEL: "6"
    steps:
      - uses: actions/checkout@v4

      # ── apt cache (avoid re-downloading ~60 MB of .debs) ──────────
      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: ~/apt-cache
          key: apt-${{ matrix.runner }}-build-v1

      - name: Install dependencies
        run: |
          if [ -d ~/apt-cache ]; then
            sudo cp -rn ~/apt-cache/. /var/cache/apt/archives/ 2>/dev/null || true
          fi
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake ccache
          mkdir -p ~/apt-cache
          cp -rn /var/cache/apt/archives/*.deb ~/apt-cache/ 2>/dev/null || true

      # ── ccache (compiler output cache — biggest speedup) ───────────
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ matrix.os }}-${{ matrix.build_type }}-${{ hashFiles('CMakeLists.txt', 'sdk/**', 'tests/**', 'examples/**') }}
          restore-keys: |
            ccache-${{ matrix.os }}-${{ matrix.build_type }}-

      - name: Configure ccache
        run: |
          ccache --zero-stats
          ccache --max-size="${CCACHE_MAXSIZE}"

      - name: Configure
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DTHUNDERBIRD_BUILD_TESTS=ON \
            -DTHUNDERBIRD_BUILD_EXAMPLES=ON \
            -DTHUNDERBIRD_USE_SIMULATED=ON

      - name: Build
        run: cmake --build build -j "$(nproc)"

      - name: Verify compiled version
        run: |
          VER=$(grep '#define THUNDERBIRD_VERSION_STRING' build/sdk/include/thunderbird/version.h \
                | sed 's/.*"\(.*\)"/\1/')
          echo "Compiled version: ${VER}"
          echo "### SDK version: \`${VER}\`" >> "$GITHUB_STEP_SUMMARY"

      - name: Test
        run: cd build && ctest --output-on-failure -j "$(nproc)"

      - name: ccache statistics
        if: always()
        run: |
          echo "### ccache (${{ matrix.os }} / ${{ matrix.build_type }})" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          ccache --show-stats >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

  # ── Debian packaging smoke test (build .deb on Ubuntu 22.04) ───────────────
  deb-smoke:
    name: "Deb smoke"
    runs-on: ubuntu-24.04
    container:
      image: ubuntu:22.04
    env:
      DEBIAN_FRONTEND: noninteractive
    steps:
      - uses: actions/checkout@v4

      - name: Install build deps
        run: |
          apt-get update -qq
          apt-get install -y --no-install-recommends \
            build-essential cmake pkg-config g++ \
            dpkg-dev debhelper devscripts fakeroot lintian \
            ca-certificates git

      - name: Stamp changelog
        run: |
          chmod +x scripts/update-changelog.sh scripts/extract-version.sh
          scripts/update-changelog.sh

      - name: Build .deb
        run: dpkg-buildpackage -us -uc -b -d --jobs="$(nproc)"

      - name: Lint packages
        run: lintian ../*.deb || true

      - name: Verify package split
        run: |
          echo "=== Runtime package ==="
          dpkg-deb -c ../libthunderbird-sdk0_*.deb
          echo ""
          echo "=== Dev package ==="
          dpkg-deb -c ../libthunderbird-sdk-dev_*.deb
          echo ""
          # Verify runtime has .so.* but NOT headers
          dpkg-deb -c ../libthunderbird-sdk0_*.deb | grep -q 'libthunderbird_sdk.so.'
          ! dpkg-deb -c ../libthunderbird-sdk0_*.deb | grep -q '/include/'
          # Verify dev has headers and .a
          dpkg-deb -c ../libthunderbird-sdk-dev_*.deb | grep -q '/include/thunderbird/'
          dpkg-deb -c ../libthunderbird-sdk-dev_*.deb | grep -q 'libthunderbird_sdk.a'
          echo "✓ Package split verified"

  # ── Python wheel smoke test (single arch, single Python, x86_64) ──────────
  wheel-smoke:
    name: "Wheel smoke"
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip                   # caches ~/.cache/pip keyed on pyproject.toml

      - name: Install cibuildwheel
        run: pip install cibuildwheel==2.21.*

      - name: Build one wheel (cp312, x86_64, manylinux2014)
        run: cibuildwheel --output-dir dist
        env:
          CIBW_BUILD: "cp312-manylinux_x86_64"
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux2014
          CIBW_BEFORE_ALL_LINUX: >-
            yum install -y ninja-build || true &&
            /opt/python/cp312-cp312/bin/pip install cmake &&
            ln -sf /opt/python/cp312-cp312/bin/cmake /usr/local/bin/cmake
          CIBW_REPAIR_WHEEL_COMMAND_LINUX: >-
            auditwheel show {wheel} &&
            auditwheel repair --plat manylinux2014_x86_64 -w {dest_dir} {wheel}
          CIBW_TEST_COMMAND: >-
            python -c
            "import spatial_sdk;
            print(f'spatial_sdk {spatial_sdk.__version__}');
            print(f'Status.OK = {spatial_sdk.Status.OK}');
            info = spatial_sdk.DeviceInfo();
            print(f'DeviceInfo: {info}');
            print('OK — wheel smoke test passed')"

      - name: Verify wheel is manylinux2014 tagged
        run: |
          pip install pkginfo
          WHL=$(ls dist/*.whl | head -1)
          echo "Built: $(basename $WHL)"
          python -c "
          from pkginfo import Wheel
          w = Wheel('$WHL')
          print(f'Name:     {w.name}')
          print(f'Version:  {w.version}')
          fname = '$(basename $WHL)'
          assert 'manylinux2014' in fname or 'manylinux_2_17' in fname, \
            f'Wheel not tagged manylinux2014: {fname}'
          print('✓ manylinux2014 tag verified')
          "

  # ── Docker image smoke test (single arch, native) ──────────────────────────
  docker-smoke:
    name: "Docker ${{ matrix.variant }}"
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        variant: [runtime, dev]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.variant }} image (native arch only)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.${{ matrix.variant }}
          platforms: linux/amd64
          load: true
          tags: thunderbird-${{ matrix.variant }}:smoke
          build-args: |
            VERSION=0.0.0
          cache-from: type=gha,scope=ci-docker-${{ matrix.variant }}
          cache-to: type=gha,mode=max,scope=ci-docker-${{ matrix.variant }},ignore-error=true

      - name: Verify runtime image
        if: matrix.variant == 'runtime'
        run: |
          echo "=== Image size ==="
          docker images thunderbird-runtime:smoke --format '{{.Size}}'

          echo "=== Shared library present ==="
          docker run --rm thunderbird-runtime:smoke \
            sh -c 'ldconfig -p | grep thunderbird'

          echo "=== No build tools (minimal) ==="
          ! docker run --rm thunderbird-runtime:smoke which gcc 2>/dev/null
          echo "✓ Runtime image verified"

      - name: Verify dev image
        if: matrix.variant == 'dev'
        run: |
          echo "=== Image size ==="
          docker images thunderbird-dev:smoke --format '{{.Size}}'

          echo "=== SDK installed ==="
          docker run --rm thunderbird-dev:smoke \
            pkg-config --modversion thunderbird-sdk

          echo "=== Headers present ==="
          docker run --rm thunderbird-dev:smoke \
            test -f /usr/include/thunderbird/thunderbird.h

          echo "=== Build tools available ==="
          docker run --rm thunderbird-dev:smoke cmake --version
          docker run --rm thunderbird-dev:smoke g++ --version | head -1

          echo "=== Tests pass ==="
          docker run --rm thunderbird-dev:smoke \
            sh -c 'cd /thunderbird/build && ctest --output-on-failure -j $(nproc)'

          echo "✓ Dev image verified"

  # ── Dev artifact publishing (push to main only) ────────────────────────────
  # Publishes Docker images with :dev and :dev-<sha7> tags to GHCR.
  # Uses GHA layer cache from docker-smoke — effectively a manifest push.
  # Requires all smoke tests to pass before publishing.
  dev-publish:
    name: "Dev publish"
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [build-and-test, deb-smoke, wheel-smoke, docker-smoke]
    runs-on: ubuntu-24.04
    environment: dev
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: true
      matrix:
        variant: [runtime, dev]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push dev image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.${{ matrix.variant }}
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/${{ github.repository }}-${{ matrix.variant }}:dev
            ghcr.io/${{ github.repository }}-${{ matrix.variant }}:dev-${{ github.sha }}
          build-args: VERSION=0.0.0-dev
          cache-from: type=gha,scope=ci-docker-${{ matrix.variant }}
          cache-to: type=gha,mode=max,scope=ci-docker-${{ matrix.variant }},ignore-error=true

      - name: Step summary
        run: |
          IMAGE="ghcr.io/${{ github.repository }}-${{ matrix.variant }}"
          SHA7="${{ github.sha }}"
          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          ### Dev publish: ${{ matrix.variant }}
          | Tag | Image |
          |-----|-------|
          | \`dev\` | \`${IMAGE}:dev\` |
          | \`dev-${SHA7:0:7}\` | \`${IMAGE}:dev-${SHA7}\` |
          EOF
